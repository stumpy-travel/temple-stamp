<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¯ºå»Ÿé›†ç« </title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2em;
    }
    img {
      margin-top: 1em;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    button {
      margin-top: 30em;
      padding: 40px 60px;
      font-size: 5em;
      border: none;
      border-radius: 40px;
      background-color: #ccc;
      cursor: not-allowed;
    }
    #success-message {
      margin-top: 1.5em;
    }
    #distance-info {
      margin-top: 1em;
      font-size: 1.1em;
      color: #555;
    }
  </style>
</head>
<body>

  <audio id="notify-sound" src="audio/level-up.mp3" preload="auto"></audio>
  
  <h1 id="temple-title">æœ­æ‰€</h1>
  <p id="status">æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®â€¦</p>
  <p id="distance-info"></p>

  <div id="success-message" style="display: none;">
    <p>âœ… æ‚¨å·²æˆåŠŸé›†ç« ï¼</p>
    <img id="stamp-image" src="" alt="å¯ºå»Ÿç« åœ–" width="120" />
    <br />
    <button onclick="clearStamp()">ğŸ—‘ï¸ å–æ¶ˆé›†ç« è¨˜éŒ„</button>
  </div>

  <script>
    // å¯ºå»Ÿè³‡æ–™
    const temples = {
      "001": {
        name: "å¥§ç¾å»£å‘Š",
        lat: 25.03704,
        lng: 121.56925,
        image: "https://stumpy-travel.github.io/temple-stamp/stamps/Ogilvy.jpg"
      }
    };

    const query = new URLSearchParams(window.location.search);
    const templeId = query.get("temple");

    if (!templeId || !temples[templeId]) {
      document.getElementById("status").innerText = "âŒ ç„¡æ•ˆçš„å¯ºå»Ÿ ID";
      document.getElementById("temple-title").innerText = "ç„¡æ³•è¼‰å…¥å¯ºå»Ÿè³‡æ–™";
      throw new Error("Invalid temple ID");
    }

    const temple = temples[templeId];
    document.getElementById("temple-title").innerText = temple.name;

    const saved = localStorage.getItem(`stamp-${templeId}`);
    if (saved === "true") {
      showSuccess();
    } else {
      getLocation();
    }

    function getLocation() {
      if (!navigator.geolocation) {
        document.getElementById("status").innerText = "âŒ ç„¡æ³•å–å¾—å®šä½ï¼šæ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚";
        return;
      }

      navigator.geolocation.getCurrentPosition(success, error);
    }

    function success(position) {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      const distance = getDistance(userLat, userLng, temple.lat, temple.lng);
      const distanceDisplay = Math.round(distance);

      if (distance <= 300) {
        document.getElementById("notify-sound").play();
        localStorage.setItem(`stamp-${templeId}`, "true");
        showSuccess();
      } else {
        document.getElementById("status").innerText = "âŒ å°šæœªé€²å…¥å¯é›†ç« ç¯„åœ";
        document.getElementById("distance-info").innerText = `ğŸ“ æ‚¨ç›®å‰è·é›¢ã€Œ${temple.name}ã€é‚„æœ‰ ${distanceDisplay} å…¬å°ºã€‚è«‹é è¿‘è‡³ 300 å…¬å°ºå…§å†è©¦ä¸€æ¬¡ã€‚`;
      }
    }

    function error(err) {
      document.getElementById("status").innerText = "âŒ å–å¾—å®šä½å¤±æ•—ï¼š" + err.message;
    }

    function showSuccess() {
      document.getElementById("status").style.display = "none";
      document.getElementById("distance-info").style.display = "none";
      document.getElementById("success-message").style.display = "block";
      document.getElementById("stamp-image").src = temple.image;
    }

    function clearStamp() {
      localStorage.removeItem(`stamp-${templeId}`);
      location.reload();
    }

    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
      const rad = Math.PI / 180;
      const dLat = (lat2 - lat1) * rad;
      const dLng = (lng2 - lng1) * rad;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * rad) * Math.cos(lat2 * rad) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
  </script>

</body>
</html>
